<style>
  :root {
    --primary-color: #4CAF50;
    --in-progress-color: #FF8F00;
    --check-it-color: rgb(30, 113, 247);
    --not-relevant-color: #9E9E9E;
    --font-family: 'Roboto', sans-serif;
    --spacing-s: 8px;
    --spacing-m: 16px;
    --button-width: 200px;
    --border-radius: 4px;
    --font-size: 14px;
    --transition: 0.2s;
    --ghost-button-color: #333333;
    --figma-color-bg: #ffffff;
    --figma-color-text: rgba(0, 0, 0, 0.9);
    --figma-color-border: rgba(0, 0, 0, 0.1);
    --button-secondary-bg: rgba(0, 0, 0, 0.05);
    --button-secondary-pressed: rgba(0, 0, 0, 0.1);
    --button-secondary-hover: rgba(0, 0, 0, 0.08);
    --input-padding: var(--spacing-s);
    --input-border: 1px solid var(--figma-color-border);
    --focus-outline: 2px solid black;
  }

  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-s);
    padding: 8px var(--spacing-m); /* Уменьшаем отступ сверху с var(--spacing-m) до 8px */
    /* padding-bottom: 80px; */
    font-family: var(--font-family);
    background-color: white;
    color: var(--figma-color-text);
  }

h4 {
  margin: 4px 0; /* Уменьшаем отступы вокруг всех h4 */
}

  /* Общие стили для всех кнопок */
  button {
    width: var(--button-width);
    padding: var(--spacing-s) var(--spacing-m);
    border-radius: var(--border-radius);
    font-family: var(--font-family);
    font-size: var(--font-size);
    border: 1px solid var(--figma-color-border);
    color: var(--figma-color-text);
    cursor: pointer;
    transition: all var(--transition);
    background-color: var(--button-secondary-bg);
  }

  button:focus {
    outline: 2px solid black;
    outline-offset: 2px;
  }

  button:hover {
    background-color: var(--button-secondary-hover);
  }

  button:active {
    background-color: var(--button-secondary-pressed);
  }

  /* Специфичные цвета для кнопок статуса */
  .status-button.in-progress { background-color: var(--in-progress-color); }
  .status-button.check-it { background-color: var(--check-it-color); color: white; }
  .status-button.not-relevant { background-color: var(--not-relevant-color); }
  .status-button.done { background-color: var(--primary-color); }

  /* Контейнер для инпута и кнопки */
  .task-input-container {
    display: flex;
    gap: var(--spacing-s);
    margin-top: var(--spacing-s);
    width: var(--button-width);
  }
  .task-input-container input {
    padding: var(--spacing-s);
    border-radius: var(--border-radius);
    font-family: var(--font-family);
    font-size: var(--font-size);
    border: 1px solid var(--figma-color-border);
  }
  /* Добавляем стили для нового контейнера */
  .check-it-container {
    display: flex;
    gap: var(--spacing-s);
    /* width: var(--button-width); */
  }

  .check-it-container input {
    padding: var(--spacing-s);
    border-radius: var(--border-radius);
    font-family: var(--font-family);
    font-size: var(--font-size);
    border: 1px solid var(--figma-color-border);
  }


  /* Стили для input */
  input[type="number"] {
    padding: var(--input-padding);
    border-radius: var(--border-radius);
    font-family: var(--font-family);
    font-size: var(--font-size);
    border: var(--input-border);
  }

  input[type="number"]:focus {
    outline: 2px solid black;
    outline-offset: -1px;
    border-color: transparent;
  }

  /* Добавляем разделитель */
  .separator {
    width: var(--button-width);
    height: 1px;
    background-color: var(--not-relevant-color);
    margin: var(--spacing-m) 0;
    opacity: 0.5;
  }

  /* Группируем элементы для работы с задачами */
  .task-management {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-s);
    width: var(--button-width);
    padding-top: var(--spacing-s);
  }

  /* Группируем элементы для работы со статусами */
  .status-management {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-s);
    width: var(--button-width);
  }

  /* Адаптивность */
  @media (max-width: 600px) {
    button,
    .task-input-container,
    .separator,
    .task-management,
    .status-management,
    .check-it-container {
      width: 100%;
    }
  }

  /* Стиль для кнопки "Добавить" */
  #addTask {
    background-color: var(--figma-color-text);
    color: var(--figma-color-bg);
  }
  #addTask:hover {
    background-color: var(--figma-color-text);
    color: var(--figma-color-bg);
  }

  /* Обновляем стиль для ghost-кнопки */
  .ghost-button {
    background-color: transparent;
    border: 1px solid var(--figma-color-text);
    color: var(--figma-color-text);
  }

  .ghost-button:hover {
    background-color: var(--figma-color-bg-hover);
    color: var(--figma-color-bg);
    opacity: 1;
  }

  .ghost-button:focus {
    outline: 2px solid var(--figma-color-border-brand-strong);
    outline-offset: 2px;
  }

  /* Создать общий класс для инпутов */
  .input-common {
    padding: var(--input-padding);
    border-radius: var(--border-radius);
    font-family: var(--font-family);
    font-size: var(--font-size);
    border: var(--input-border);
  }

  /* Использовать общий класс */
  .task-input-container input,
  .check-it-container input,
  input[type="number"] {
    padding: var(--input-padding);
    border-radius: var(--border-radius);
    font-family: var(--font-family);
    font-size: var(--font-size);
    border: var(--input-border);
}

  /* Стили для ссылки очистки */
  .clear-link {
    margin-top: var(--spacing-s);
    color: var(--not-relevant-color);
    text-decoration: none;
    font-size: 14px;
  }

  .clear-link:hover {
    text-decoration: underline;
  }
</style>
<h4>Статусы</h4>
<div class="status-management">
  <!-- Кнопки статусов -->
  <button class="status-button in-progress" data-status="in-progress">В процессе</button>
  <div class="check-it-container">
    <input 
      type="text" 
      id="checkItTaskInput" 
      placeholder="№ задачи"
      pattern="[0-9]*"
      aria-label="Номер задачи для проверки"
    >
    <button class="status-button check-it" data-status="check-it" aria-label="Отправить задачу на проверку">
      На проверку
    </button>
  </div>
  <button class="status-button not-relevant" data-status="not-relevant">Не актуально</button>
  <button class="status-button done" data-status="done">Готово</button>
</div>
<!-- Разделитель -->
<div class="separator"></div>
<h4>Связанные задачи</h4>
<!-- Секция работы с задачами -->
<div class="task-management">
  <div class="task-input-container">
    <input 
      type="text" 
      id="taskInput" 
      placeholder="№ задачи"
    >
    <button id="addTask">Добавить</button>
  </div>
  <button id="rewrite" class="ghost-button">[...] -> ссылки</button>
</div>

<!-- Добавляем ссылку для очистки -->
<a href="#" id="clearTasks" class="clear-link">Очистить</a>

<script>
  const buttons = Array.from(document.querySelectorAll('.status-button'));
  let currentFocusIndex = -1;

  // Устанавливаем фокус на кнопку "Готово" при загрузке
  window.addEventListener('load', () => {
    currentFocusIndex = buttons.length - 1; // Индекс последней кнопки
    buttons[currentFocusIndex].focus();
  });

  const updateStatus = (status, taskId = '') => {
    parent.postMessage({ 
      pluginMessage: { 
        type: 'update-status', 
        status,
        taskId 
      } 
    }, '*');
  };
  
  // Обработчик клика по кнопкам
  document.querySelectorAll('.status-button').forEach(button => {
    button.onclick = () => {
      const status = button.dataset.status;
      if (status === 'check-it') {
        const taskInput = document.getElementById('checkItTaskInput');
        const taskValue = taskInput.value.trim();
        
        // Проверяем, что введено только число или пустая строка
        if (taskValue && !/^\d+$/.test(taskValue)) {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'error',
              message: 'Введите корректный номер задачи (только цифры)'
            } 
          }, '*');
          return;
        }
        
        updateStatus(status, taskValue);
        taskInput.value = '';
      } else {
        updateStatus(status);
      }
    };
  });

  // Обработчик клавиатуры
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      e.preventDefault();
      currentFocusIndex = (currentFocusIndex + 1) % buttons.length;
      buttons[currentFocusIndex].focus();
    }
    // Добавляем обработку стрелок
    if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
      e.preventDefault();
      currentFocusIndex = (currentFocusIndex + 1) % buttons.length;
      buttons[currentFocusIndex].focus();
    }
    if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
      e.preventDefault();
      currentFocusIndex = (currentFocusIndex - 1 + buttons.length) % buttons.length;
      buttons[currentFocusIndex].focus();
    }
    if (e.key === 'Enter' && document.activeElement instanceof HTMLButtonElement) {
      updateStatus(document.activeElement.dataset.status);
    }
  });

  // Обработчики для Task-linker
  document.getElementById('rewrite').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'rewrite-tasks' } }, '*')
  }

  // Функции для валидации и отображения ошибок
  const validateInput = (value, pattern) => {
    if (!value) return { isValid: false, message: 'Введите номер задачи' };
    if (!pattern.test(value)) return { isValid: false, message: 'Можно вводить только цифры, пробелы и запятые' };
    return { isValid: true };
  };

  const showError = (message) => {
    parent.postMessage({ 
      pluginMessage: { 
        type: 'error',
        message 
      } 
    }, '*');
  };

  // Функция для добавления задачи
  function addTask() {
    const taskInput = document.getElementById('taskInput');
    const taskIds = taskInput.value.trim();
    
    const validation = validateInput(taskIds, /^[\d,\s]+$/);
    if (!validation.isValid) {
      showError(validation.message);
      return;
    }
    
    parent.postMessage({ 
      pluginMessage: { 
        type: 'add-task',
        taskId: taskIds 
      } 
    }, '*');
    taskInput.value = ''; // Очищаем поле после отправки
  }

  // Обработчик для кнопки добавления
  document.getElementById('addTask').onclick = addTask;

  // Добавляем обработчик Enter для поля ввода
  document.getElementById('taskInput').addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
      event.preventDefault();
      addTask();
    }
  });

  // Добавляем обработчик для очистки
  document.getElementById('clearTasks').onclick = (e) => {
    e.preventDefault();
    parent.postMessage({ 
      pluginMessage: { 
        type: 'clear-tasks'
      } 
    }, '*');
  };
</script>